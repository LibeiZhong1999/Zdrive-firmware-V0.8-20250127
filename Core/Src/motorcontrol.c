#include "motorcontrol.h"


const float one_div_sq_three=0.57735026919;
const float sq_three=1.7320508075688;
const uint32_t ARR=8400;
const float cycle=0.00016,one_div_cycle=6250,Ld=0.000042,Lq=0.000042,R=0.08,pole_pair=7,angle_offset=8670;//cycle=160us
const float pi=3.141592653589793238462643;
const float rad_to_deg=57.295779,pulse_to_rad=0.00306796157577128245943617517898;
const float k_tor=0.025,one_div_k_tor=40,J_iner=2e-6,i_vec_mod_lim=45,vel_ref_lim=3000*2*pi/60;

float ia,ib,ic,ua,ub,uc,tem,dc_bus=10,ia_carli=0,ib_carli=0,ic_carli=0,theta_e=0,scalefactor;
float sintest,costest,sintest1,costest1;
uint32_t ia_u32,ib_u32,ic_u32,ia_carli_u32,ib_carli_u32,ic_carli_u32;
float id_ref,id,id_pre=0,kp_d,ki_d,integ_d=0,ud,ud_mod;
float iq_ref,iq,iq_pre=0,kp_q,ki_q,integ_q=0,uq,uq_mod;
float theta_m=-1,theta_m_pre=-1,vel_m;
float vel_ref,kp_vel,ki_vel,integ_vel=0;
float pos_ref,kp_pos,integ_pos=0;
float vel_fil,vel_fil_pre=-1;
int16_t encPositionA;

const float iq_anticog[2048]={-0.277744,-0.110188,-0.004188,-0.149316,-0.315649,-0.070767,-0.082440,-0.009973,-0.181903,-0.119330,-0.107592,-0.138882,-0.128515,-0.164764,0.007303,0.027658,-0.134964,0.007968,-0.007505,-0.117306,-0.109267,-0.026883,0.005041,-0.031449,-0.006836,-0.009309,-0.083676,-0.109519,0.017640,0.057518,-0.011839,0.032995,0.103790,-0.120472,-0.094360,0.049697,0.065025,0.008352,0.128819,0.065811,-0.118362,-0.079388,0.165063,0.288228,-0.051502,0.073535,0.193968,-0.024694,0.055557,-0.037242,0.054980,0.187108,0.065946,0.121988,0.065184,0.173738,0.142490,0.176695,0.081855,0.302950,0.161652,0.296021,0.228639,0.282143,0.177590,0.295847,0.152323,0.288200,0.295696,0.248042,0.287647,0.310893,0.312873,0.421607,0.324398,0.336014,0.290133,0.415891,0.298952,0.217074,0.371220,0.253617,0.342014,0.327832,0.272905,0.194683,0.173285,0.275882,0.443631,0.299490,0.304816,0.344584,0.171661,0.301671,0.293357,0.198749,0.228432,0.368319,0.123468,0.171495,0.002657,0.232307,0.082648,0.042067,0.232454,0.059759,0.076583,0.088643,0.193057,-0.037007,-0.052046,0.081653,0.205729,0.086171,0.054733,0.184989,0.238160,0.033725,-0.016040,0.073235,0.083745,0.104086,0.128998,0.051079,0.150604,-0.003207,0.171812,0.152339,0.127247,0.100091,0.110806,0.034886,0.019637,0.042092,0.093137,0.139838,0.033214,0.006830,0.000674,-0.059999,0.127369,0.210515,0.031754,0.237659,-0.008408,0.039651,-0.043561,-0.101565,0.077800,-0.052672,-0.071730,-0.135274,-0.088988,0.042223,-0.028714,0.043638,-0.189044,0.060863,0.092620,-0.059975,-0.028590,-0.007675,-0.039714,-0.072690,-0.130049,-0.236798,0.075692,-0.075613,-0.111216,-0.031102,-0.120438,-0.034757,0.092447,-0.017648,-0.058356,-0.002216,0.025489,-0.220753,-0.020937,0.020025,0.017272,0.100096,-0.053960,-0.019071,0.143452,-0.039009,0.058312,0.074151,-0.068255,0.011599,0.044570,0.074599,0.159379,0.010902,-0.001026,0.173848,0.183520,0.118224,0.127850,0.085601,0.227696,0.106971,-0.073977,-0.020244,0.204201,0.263891,-0.043414,0.252923,0.230085,0.219141,0.163768,0.159996,0.287118,0.264305,0.108529,0.253383,0.078297,0.130005,0.218711,0.116266,0.215337,0.243723,0.118015,-0.035036,0.143590,0.159558,0.292174,0.087934,0.215936,0.148440,0.038238,0.058972,0.208697,0.069526,0.266654,0.225647,0.358887,0.260820,0.329132,0.191318,0.321692,0.280760,0.046159,0.165848,0.239697,0.308653,0.186777,0.213168,0.145651,0.244656,0.210268,0.244607,0.400266,0.207530,0.214417,0.157686,0.072143,0.267935,0.229142,0.228624,0.146413,0.133617,0.116300,0.226945,0.339684,0.203395,0.171454,0.012446,0.149667,0.201133,0.052017,0.248127,0.126691,0.135842,0.168034,0.102738,0.158987,0.058696,0.054465,0.078041,0.028603,0.006396,0.149632,0.123697,0.037961,0.105221,0.068612,-0.104967,0.013391,0.127890,0.109066,-0.112706,0.177209,0.059664,-0.148152,0.021025,-0.002388,0.060913,0.050210,-0.076036,0.186205,-0.038039,0.099694,0.019724,0.096021,0.094960,0.048661,-0.058809,0.013408,0.022458,0.013636,0.138835,0.180568,-0.134855,0.029524,0.032804,0.041068,-0.151851,-0.053220,-0.252145,-0.187978,-0.110953,-0.168723,-0.196507,-0.172510,-0.075862,-0.089437,0.045803,0.022164,-0.101739,0.046296,0.147498,0.078488,-0.042565,0.036656,0.156491,-0.059555,0.025083,0.123132,0.082687,0.019348,-0.001423,0.038356,-0.002378,0.115624,-0.055891,-0.143315,0.001112,0.034461,0.091849,0.002029,0.112893,-0.019052,-0.102846,0.142960,0.013680,0.047116,0.148444,0.071729,0.169172,0.171524,0.177283,0.143367,0.115124,0.115456,0.214305,0.152824,0.214336,0.174668,0.242767,0.111482,0.275323,0.311047,0.153380,0.201180,0.151770,0.236342,0.145542,0.187844,0.065598,0.252094,0.112487,0.074559,0.209691,0.251294,0.015577,0.272158,0.157666,0.255881,0.007399,-0.110972,0.106061,0.093483,-0.023371,0.070043,-0.072457,0.100874,0.105953,0.109700,-0.003686,0.040796,-0.048350,0.110289,0.125797,0.112123,0.147930,0.124507,-0.045202,-0.113318,0.362800,0.250415,0.255969,0.147044,0.127088,0.183848,0.022225,0.114238,0.133464,0.148411,0.299559,0.254433,0.102142,0.151158,0.167227,0.279138,0.214088,0.072671,0.160307,0.155471,0.259994,0.185458,0.251638,0.189292,0.028902,-0.076333,0.055555,0.313052,0.030403,0.098813,0.045508,0.080314,0.169442,0.095250,-0.007118,0.117901,-0.000474,-0.142188,0.080662,0.019413,0.091149,-0.030037,-0.054944,0.042336,-0.045145,0.129329,-0.024689,0.047984,0.082045,-0.048854,0.000621,0.066994,0.073080,-0.092785,0.073369,-0.144780,0.075654,0.088775,0.072189,-0.008327,0.108965,0.191329,0.263116,0.196223,0.157304,0.192586,0.089582,0.198911,0.324495,0.189246,0.206152,0.083348,0.204024,-0.007115,0.040723,0.070481,0.107670,0.146204,0.075994,0.011633,0.138720,0.033728,0.085862,-0.054085,0.032911,-0.024015,-0.084739,0.081971,0.164767,-0.011537,0.042259,0.109941,0.130784,-0.052558,0.272709,0.134376,0.160165,0.140253,0.028676,0.100283,0.137858,0.045718,0.062530,0.035985,0.114271,0.021868,0.042793,-0.073272,0.167086,-0.060638,0.123249,0.009070,0.102370,-0.015523,0.159402,0.066899,0.030451,0.024838,0.180312,-0.013511,0.080901,0.092435,-0.010031,-0.071953,0.079606,0.030487,-0.044486,0.081503,0.080197,-0.040682,-0.069786,0.129690,0.089915,0.153953,0.105893,0.170471,0.028001,0.052535,-0.003569,0.063381,0.080214,-0.004371,0.012465,0.003216,-0.004026,-0.065202,-0.045962,0.139173,-0.053742,-0.070099,0.015281,0.145693,0.081090,0.117625,0.051911,0.078927,0.107648,0.079859,0.062330,0.111055,0.021687,-0.110224,0.000843,-0.019773,0.104704,0.056700,0.064627,0.086384,0.126989,0.005599,0.165577,0.148990,0.245354,0.216016,0.110881,0.102306,0.209366,0.087603,0.368803,0.156209,0.169405,0.155540,0.189099,0.102937,0.092165,0.130692,0.104793,0.105936,-0.008733,0.107689,0.087605,0.243604,0.046700,0.040784,0.138789,0.048933,0.184197,0.017891,0.122523,0.184842,0.084164,0.075662,0.085557,0.172675,0.126123,0.111964,0.035141,0.009936,0.047674,0.085796,0.138980,-0.098558,0.021868,-0.047685,0.097406,0.074629,0.099425,0.157075,0.213119,0.167923,0.175588,0.015865,-0.027324,0.086347,0.170783,0.065740,0.173770,0.170623,0.005516,0.142747,0.172048,0.256301,0.192031,0.261621,0.137553,0.291467,0.245835,0.241786,0.178885,0.181121,0.297234,0.166123,0.192401,0.257654,0.262347,0.087800,0.204951,0.113479,0.096345,0.281462,0.202784,0.195263,0.020444,0.127646,0.202037,0.094014,0.122520,0.113870,0.172361,0.155596,0.103549,0.076011,-0.114156,0.042528,0.091564,0.073837,0.050243,0.122379,0.172696,0.111992,0.036044,0.110955,0.060434,0.040972,0.021507,0.012672,0.019236,-0.021066,-0.002738,0.009888,-0.003378,-0.043219,-0.109880,0.124822,-0.000236,-0.006509,-0.056969,-0.068200,-0.011355,-0.031460,-0.170316,-0.127312,-0.042098,0.114104,0.058986,-0.125335,0.009527,0.019104,0.066992,0.087478,0.063483,0.130991,0.047055,0.165462,0.059535,0.088275,-0.049803,0.215696,-0.058047,-0.134898,0.156576,-0.048225,0.144895,0.106188,0.083551,0.169482,0.100185,-0.029392,0.082749,0.142195,-0.001064,-0.068022,0.030357,0.000364,-0.036853,0.039010,0.138137,0.043465,-0.189167,0.138782,0.106530,0.094245,0.052472,0.119746,0.151138,-0.071046,0.040539,0.082097,0.133455,0.014391,0.008488,0.140025,0.146454,0.094823,0.193020,-0.034737,0.089653,0.080380,0.204765,0.374525,0.119487,0.196168,0.307717,0.281750,0.163759,0.210095,0.343866,0.265149,0.182110,0.320881,0.366667,0.334924,0.182871,0.103718,0.318692,0.239843,0.183660,0.165370,0.170792,0.257094,0.212666,0.270151,0.152462,0.098379,0.044737,0.045803,0.198829,0.214930,0.108421,0.152106,0.129661,0.228735,0.171942,0.289865,0.231085,0.165147,0.281579,0.072785,0.111484,-0.027520,0.288930,0.102939,0.207282,0.113378,0.186067,0.169844,0.160455,0.124383,0.065143,0.151395,0.129907,0.206271,0.231883,0.168680,0.188734,0.236797,0.211064,0.257356,0.136271,0.291831,0.252501,0.205313,0.164237,0.135447,0.039095,0.225508,0.182443,0.114722,0.059472,-0.038520,0.001860,0.092848,-0.022287,0.111333,0.011885,0.063585,0.056157,-0.065571,0.110415,0.043739,-0.075504,-0.035454,0.004713,0.106865,0.076036,-0.000821,0.149711,0.119113,0.054265,-0.029992,0.088946,0.078796,0.039678,-0.002236,0.069770,-0.042569,0.089360,-0.015008,0.089173,0.113047,0.041539,0.030426,-0.086934,-0.052178,0.076355,0.109136,-0.113057,-0.133509,0.155907,0.006104,0.019856,0.048094,-0.039420,-0.073081,-0.046521,-0.056659,0.104693,-0.061669,-0.071552,0.056438,-0.134479,0.063073,0.064913,0.163945,0.170547,-0.160815,-0.041847,0.071034,-0.127222,0.084343,-0.028684,0.025906,0.067248,0.151660,0.068508,-0.033869,-0.017989,0.006113,-0.034240,0.047418,0.026039,-0.036939,-0.166267,-0.110653,-0.181260,-0.124180,0.120892,0.079194,-0.102606,0.029530,-0.130343,0.032061,0.158831,0.086822,-0.080073,-0.062408,0.043951,0.175860,0.322746,0.049862,0.171602,0.155945,0.114597,0.183654,0.252568,0.108345,0.313118,0.104322,0.222364,0.219171,0.272306,0.386458,0.176664,0.305781,0.420198,0.329421,0.302283,0.370134,0.359342,0.206886,0.488723,0.348688,0.328123,0.312053,0.439873,0.273014,0.270345,0.171905,0.237496,0.412266,0.127522,0.090622,0.224100,0.093163,0.332525,0.182496,0.078820,0.119501,0.284421,0.061213,0.176639,0.168128,0.058325,0.119095,0.275095,0.218620,0.213415,0.318358,0.180993,0.176230,0.147525,-0.072002,0.159032,0.115653,0.292425,0.100492,0.280156,-0.086906,0.140551,0.077993,0.070273,0.228024,0.311367,0.058924,-0.024395,-0.094351,0.227527,0.192249,0.010603,0.296946,0.203668,0.004402,0.078164,0.160773,-0.048020,0.148205,0.075043,-0.089606,0.025591,0.033752,0.084453,0.047742,-0.076189,0.048449,0.066975,-0.113552,-0.040565,-0.007271,-0.025950,-0.078096,0.088373,-0.133902,0.000568,0.101311,0.002154,0.006355,-0.000332,-0.185213,-0.045985,0.006919,0.035894,0.078426,-0.127301,-0.124435,0.091424,-0.041071,0.003191,0.051288,-0.147353,0.046469,-0.120789,-0.040816,-0.058964,0.098166,-0.023114,-0.135521,-0.164149,-0.075633,-0.190947,-0.022591,-0.002168,-0.074572,-0.128581,-0.031364,0.051928,-0.024068,-0.000513,-0.028847,0.109280,-0.017420,0.097216,-0.117103,0.021807,-0.022214,-0.040296,0.000749,-0.048084,0.076044,0.194802,0.037893,-0.109668,0.102421,-0.021680,0.144261,0.174891,0.128833,0.369266,0.069135,0.117293,0.050011,0.116156,0.150897,0.140867,0.162269,0.013843,0.207369,0.109319,0.014427,0.148221,0.051902,0.265999,0.147411,0.148671,0.039956,0.016587,0.196532,0.199431,0.339681,0.095530,0.286308,0.117278,0.283524,0.223060,0.172814,0.379986,0.299632,0.207074,0.413123,0.213235,0.315935,0.444215,0.212069,0.230052,0.318766,0.202739,0.093822,0.282039,0.207404,0.363810,0.265936,0.443493,0.303150,0.312766,0.372628,0.202383,0.428008,0.391522,0.334502,0.240739,0.247199,0.206521,0.498998,0.207784,0.235763,0.114465,0.134226,0.041582,0.051718,0.259672,0.204755,-0.007219,0.025705,0.054456,0.050738,0.089208,0.014196,0.061793,-0.000247,0.254695,-0.108570,0.149477,0.095307,0.152655,0.104006,0.170273,0.158871,0.113070,0.122705,0.007162,0.203277,-0.034806,0.010721,0.149703,0.010555,0.277935,0.068054,0.090029,0.139957,0.081632,0.124391,0.008428,0.073377,0.160730,-0.028775,0.122931,0.041044,0.134973,0.099319,-0.027127,0.155821,0.011405,-0.094104,-0.056234,-0.001233,0.025621,0.049904,-0.023221,-0.083797,-0.048846,-0.021889,-0.265874,-0.196194,-0.097157,0.118285,-0.139408,-0.070886,-0.110117,-0.189765,-0.108547,-0.011922,-0.018756,-0.021029,-0.016484,-0.080655,-0.086834,0.020551,0.069582,-0.022271,-0.100544,-0.046163,0.003404,-0.054318,-0.152021,-0.003662,0.005660,-0.094407,-0.099230,0.037031,-0.021268,0.130564,-0.054067,0.129896,0.008016,0.056858,-0.045125,-0.012681,0.177966,-0.032892,0.165103,-0.021600,-0.042130,0.033619,-0.017264,0.038772,0.095347,0.010271,0.147250,0.222366,0.077098,-0.006594,0.218893,0.141524,0.166518,0.224794,0.273915,0.082189,0.204702,0.083138,0.300464,0.072225,0.162718,0.157381,0.206866,0.202380,0.221561,0.274650,0.243250,0.079308,0.018135,0.143595,0.142534,0.202043,0.210446,0.171401,0.264596,0.175681,0.129750,0.048265,0.191339,0.302556,0.085783,0.257961,0.257099,0.089280,0.108016,0.290891,0.215265,0.289154,0.281881,0.294696,0.109718,0.100075,0.298504,0.151495,0.106666,0.269135,0.210352,0.044091,0.308806,0.240663,0.201948,0.237902,0.130430,0.273314,0.210007,0.266000,0.176398,0.202976,0.264469,0.236469,0.315323,0.110831,0.227901,0.150896,0.144278,-0.001365,0.104733,0.021922,0.028695,0.169579,0.018070,0.243005,0.139843,0.042361,0.056463,0.047141,0.293264,0.200324,0.089681,0.171015,0.122842,-0.038554,0.166031,0.202039,-0.009537,0.034672,-0.020636,0.088694,-0.050177,-0.032270,0.073362,0.167793,0.035307,0.135530,0.080946,0.190495,-0.054822,0.150322,0.019191,0.146458,0.068964,0.014296,0.122471,0.169669,0.054468,-0.023583,0.070169,-0.023380,0.084014,0.024260,-0.036712,0.087292,-0.014451,-0.114411,-0.045415,-0.073188,-0.006185,0.066548,-0.038444,0.123282,0.040538,-0.051260,0.060121,-0.106001,-0.127769,0.033780,0.027430,0.004622,-0.051436,0.076444,0.127367,-0.015070,0.048026,0.010419,-0.030692,-0.011652,0.127118,0.045044,0.006927,-0.049872,0.156230,0.100538,0.034583,0.091057,0.146779,0.074484,0.043993,0.050229,0.217973,0.120398,0.048738,0.096340,0.027051,0.203328,0.044977,0.244655,0.161433,0.168746,0.129826,0.134142,0.097004,0.161092,0.451696,0.207536,0.207267,0.316934,0.131116,0.129739,0.055794,0.191348,0.202119,0.223465,0.166346,0.259948,0.262939,0.103910,0.139754,0.079610,0.226424,-0.016472,0.132150,0.166032,0.072825,-0.017151,0.416115,-0.022436,0.036850,0.087309,0.025662,0.137828,0.059269,0.052694,-0.003446,0.025192,0.206356,0.005031,-0.010485,0.067630,0.181264,0.138623,0.125456,0.107373,0.156750,0.096655,0.162400,0.195255,0.340341,0.138063,0.248766,0.184932,0.207436,0.222501,0.196598,0.191042,0.232835,0.077229,0.197285,0.364871,0.273647,0.247598,0.277110,0.302270,0.211855,0.170441,0.123518,0.029541,0.117050,0.131256,0.170821,0.089437,0.091340,0.072267,0.102159,0.146904,0.040576,-0.002904,0.044584,0.260039,0.023515,0.157038,0.151864,0.064244,-0.040187,-0.133050,0.086977,0.092287,0.018426,0.058711,-0.043965,0.042929,-0.090018,0.054285,0.017348,-0.040415,-0.021018,0.028937,-0.132617,-0.071115,0.051934,-0.044723,0.218730,0.046267,0.070710,0.049072,0.082000,0.038847,0.163083,0.074810,0.005161,0.185181,0.162440,-0.096318,0.143795,0.146280,0.108258,0.019704,0.098283,0.068270,0.229694,0.138097,0.074967,0.037281,0.022090,0.104510,0.073576,-0.006716,0.075715,-0.090220,0.030027,0.004762,0.100593,-0.003674,0.086463,0.188330,0.200747,0.112975,0.033325,-0.018116,0.127703,0.203250,0.184942,0.097753,0.274461,0.108797,0.069375,-0.036626,0.168517,-0.050325,0.111032,0.030301,0.131978,-0.043453,-0.003844,0.068633,0.065649,0.058161,0.127714,0.079450,0.139638,0.182219,0.110194,0.148437,0.141499,0.148423,0.132018,0.007193,-0.004453,0.056834,0.099980,-0.027732,0.175906,0.082831,0.006913,0.004666,-0.002007,0.194798,0.004032,0.094122,0.044890,0.172258,0.009258,0.046764,-0.157481,0.101213,-0.028425,-0.007869,0.022531,0.113205,0.212089,0.074208,0.038539,0.154032,0.031524,0.196734,0.185173,-0.000924,-0.065311,0.095458,0.104819,0.069580,-0.012084,0.264625,-0.144799,0.046751,0.060925,0.050306,-0.008883,-0.091842,-0.047226,0.090182,0.027269,0.053593,0.163437,0.194300,0.226149,0.113442,0.257261,0.067273,-0.085594,0.202096,0.000138,0.165420,0.149708,0.040541,0.148022,0.150965,0.077409,0.235962,0.073254,0.100640,0.203884,0.202399,0.134900,0.115841,0.098889,0.028604,0.112729,0.158017,0.104328,0.207276,0.146566,0.139326,0.150435,0.034668,0.083144,0.086366,0.111710,0.162899,0.197549,-0.051484,0.181862,0.165994,0.055937,0.249252,0.082485,0.191665,0.304470,0.102846,-0.034562,0.043505,0.184187,0.145759,0.137238,0.015744,0.146675,0.103745,0.124581,0.129778,0.156324,0.244483,0.255075,0.175415,0.092669,0.254539,0.180663,0.243304,0.106335,0.172160,0.203122,0.124113,0.048421,0.130271,0.199342,0.083184,0.269707,0.297999,0.391919,0.303877,0.150608,0.075258,0.122864,0.162447,0.076143,0.122882,0.168310,0.015236,0.211276,0.128135,0.090107,0.022074,-0.148271,0.104763,0.023904,0.153172,0.194398,0.125739,0.098050,0.303771,-0.079598,0.041564,0.017362,0.111153,0.150093,-0.091731,-0.046977,0.051891,0.058290,-0.009970,0.190198,0.111590,-0.060358,-0.054764,0.003523,0.074674,0.019856,0.096010,-0.025322,0.064471,0.044571,0.043527,0.175062,0.052721,0.101314,-0.003115,0.109613,0.050658,-0.073147,-0.045040,0.045440,-0.060479,0.052185,0.120013,-0.092494,0.110082,0.113527,0.134067,0.229921,0.168851,0.085559,0.001943,-0.115938,0.095051,-0.034465,0.162346,0.002681,0.118967,-0.056193,0.073100,0.081397,-0.009931,0.002796,0.091251,-0.100952,0.022068,-0.011682,-0.002100,0.018196,-0.023710,0.132467,-0.072743,0.006551,-0.119581,0.004529,-0.099771,0.115091,-0.032909,-0.040818,0.092652,0.086628,-0.057319,0.082195,0.042384,-0.008626,-0.023218,0.038362,-0.100887,0.024798,-0.055270,0.123213,0.137792,0.061981,0.101365,0.119652,0.081215,0.209728,0.165227,0.119727,0.173991,0.021528,0.053577,0.281577,0.068309,0.255951,0.305804,0.192695,0.183225,0.210595,0.340965,0.370692,0.289580,0.120452,0.178254,0.192977,0.084725,0.232066,0.119004,0.191900,0.226962,0.220030,0.001588,0.115779,0.400503,0.167214,0.119583,0.294340,0.176560,0.204569,0.275319,0.204085,0.435898,0.248160,0.261611,0.135119,0.296081,0.177194,0.311821,0.156946,0.206602,0.236918,0.183453,0.162155,0.206997,0.220280,0.185426,0.169099,0.272546,0.107618,0.160458,0.249569,0.166022,0.247522,0.192879,0.300159,0.196728,0.256304,0.154855,0.070522,0.199443,0.152216,0.090241,0.153963,0.167269,0.076441,0.242167,0.040731,0.054774,-0.032288,0.088931,0.020221,0.004679,0.054115,0.020750,-0.047896,0.013504,-0.117167,0.072759,-0.071699,-0.065739,0.021739,-0.025521,0.023682,-0.093169,0.094073,0.076335,0.135173,0.132292,0.055931,0.037054,0.033185,-0.060274,-0.045237,0.081580,0.018532,-0.074719,0.015879,-0.047918,0.033710,-0.035950,-0.080186,0.006574,-0.110797,-0.056110,0.031428,0.072049,0.096257,0.072201,-0.073939,0.060974,0.136451,0.185505,0.073553,-0.080847,0.090686,-0.080062,0.016816,-0.040310,0.133962,0.000929,0.000388,0.012165,-0.078883,0.046320,0.001126,-0.080414,-0.027102,0.145593,0.043141,0.071747,-0.040269,0.168774,0.051419,0.002680,0.003287,-0.061275,0.142025,0.107094,0.048174,-0.011658,-0.057951,-0.141085,-0.022051,-0.033571,0.006242,0.032603,0.101858,0.081016,0.090620,0.049680,0.190505,0.016723,0.039743,0.168295,0.201368,0.294783,0.148645,0.156579,0.233404,0.266386,0.175866,0.158326,0.165468,0.150005,0.272299,0.222936,0.358253,0.197343,0.389648,0.261476,0.422602,0.367393,0.179433,0.290709,0.196773,0.371587,0.400670,0.310008,0.260089,0.263688,0.325340,0.387506,0.359065,0.341457,0.242762,0.203240,0.372727,0.312958,0.205226,0.292173,0.203072,0.197605,0.302072,0.282021,0.092821,0.348840,0.204582,0.222644,-0.136842,-0.090724,0.152312,0.024694,0.089392,0.075574,0.111408,0.118158,0.350110,0.164533,0.184286,0.194614,0.152369,0.244607,0.104853,0.140536,0.068311,0.156588,0.001623,0.026844,0.052595,0.087966,0.054238,0.106342,0.117436,0.148887,0.314073,0.233282,0.199251,0.207005,0.235053,0.128189,0.101403,0.172883,0.033570,0.060547,-0.123650,-0.017399,-0.077316,0.075750,0.125856,-0.137615,-0.145932,0.033428,0.139707,0.035616,-0.042159,-0.041245,0.109365,0.026026,-0.120726,-0.043455,-0.062474,0.214835,0.122884,0.116451,0.027038,0.097884,-0.096150,-0.034485,-0.028237,0.093220,0.032524};

/*
*alpha beta is standized to (0,1)
**corresponding to the three phase voltage vector coordinate system standized by Vdc
*return value (tA,tB,tC,status) 
**tA is Duty cycle of axis A in [0,1],corresponding the time of high volatge
**status is bool type,identifies whether tA/tB/tC is effective
*/
struct tri_vector SVPWM(float alpha,float beta)
{
	struct tri_vector ans_vector;
	uint8_t region_num;
	float  tA,tB,tC;
	
	// identify vector region
	if(beta>=0)
	{
		if(alpha>=0)
		{
			if((alpha-one_div_sq_three*beta)>0)
				region_num=1;
			else
				region_num=2;
		}
		else
		{
			if((alpha+one_div_sq_three*beta)<=0)
				region_num=3;
			else
				region_num=2;
		}
	}
	else
	{
		if(alpha>=0)
		{
			if((alpha+one_div_sq_three*beta)>0)
				region_num=6;
			else
				region_num=5;
		}
		else
		{
			if((alpha-one_div_sq_three*beta)<0)
				region_num=4;
			else
				region_num=5;
		}
	}
	
	//calculate phase A B C duty cycle
	switch (region_num)
	{
		case 1:
		{
			float t1=alpha-one_div_sq_three*beta;
			float t2=2*one_div_sq_three*beta;
			tC=(1-t1-t2)*0.5f;
			tB=tC+t2;
			tA=tB+t1;
		}break;
		
		case 2:
		{
			float t2=alpha+one_div_sq_three*beta;
			float t3=-alpha+one_div_sq_three*beta;
			tC=(1-t2-t3)*0.5f;
			tA=tC+t2;
			tB=tA+t3;
		}break;
		
		case 3:
		{
			float t3=2*one_div_sq_three*beta;
			float t4=-alpha-one_div_sq_three*beta;
			tA=(1-t3-t4)*0.5f;
			tC=tA+t4;
			tB=tC+t3;
		}break;
		
		case 4:
		{
			float t4=-alpha+one_div_sq_three*beta;
			float t5=-2*one_div_sq_three*beta;
			tA=(1-t4-t5)*0.5f;
			tB=tA+t4;
			tC=tB+t5;
		}break;
		
		case 5:
		{
			float t5=-alpha-one_div_sq_three*beta;
			float t6=alpha-one_div_sq_three*beta;
			tB=(1-t5-t6)*0.5f;
			tA=tB+t6;
			tC=tA+t5;
		}break;
		
		case 6:
		{
			float t6=-2*one_div_sq_three*beta;
			float t1=alpha+one_div_sq_three*beta;
			tB=(1-t6-t1)*0.5f;
			tC=tB+t6;
			tA=tC+t1;
		}break;
	}
	
	ans_vector.fir=tA;
	ans_vector.sec=tB;
	ans_vector.thi=tC;
	ans_vector.sta=((tA>=0)&&(tA<=1)&&(tB>=0)&&(tB<=1)&&(tC>=0)&&(tC<=1));
	return ans_vector;
}

/*
*transfer 3 phase duty cycle(tA,tB,tC) to PWM CCR
* tA/B/C is in [0,1],corresponding the time of high volatge
*/
void apply_pwm(struct tri_vector volt_abc_v)
{
	if(volt_abc_v.sta)
	{
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_3,(uint32_t)(ARR*(1-volt_abc_v.fir)));//U
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_2,(uint32_t)(ARR*(1-volt_abc_v.sec)));//V
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_1,(uint32_t)(ARR*(1-volt_abc_v.thi)));//W
	}
	else
	{
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_3,(uint32_t)(ARR*0.5));//U
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_2,(uint32_t)(ARR*0.5));//V
		__HAL_TIM_SetCompare(&htim1,	TIM_CHANNEL_1,(uint32_t)(ARR*0.5));//W
	}
}


/*
	*transfer current vector from abc coordinate system to dq coordinate system
	*cur_abc_v=(ia,ib,ic,status)   theta_tf is the angle at which the d-axis is ahead of the a-axis  !rad
	*return para=(id,iq,default,status)
	*After transformation, the vector modulus does not change
	*In the n-phase coordinate system, if each axis component is sinusoidal and the amplitude is A, 
	the phases are 2 pi/n rad apart from each other. 
	Then the composite vector modulus is nA/2 and the angle is equal to the sinusoidal phase of the prime phase component
	*so if current vector modulus is S,then the amplitude of axis component of abc is 2S/3, dq and alpha-beta is S
*/
struct tri_vector Clark_Park_Tf(struct tri_vector cur_abc_v,float theta_tf)
{
	struct tri_vector cur_dq_v;
	if(cur_abc_v.sta)
	{
		float sin_tf,cos_tf,sin_tf_plus,sin_tf_sub,cos_tf_plus,cos_tf_sub;
		sin_tf=arm_sin_f32(theta_tf);
		cos_tf=arm_cos_f32(theta_tf);
		
		sintest=arm_sin_f32(theta_tf);
		costest=arm_cos_f32(theta_tf);
		
		sin_tf_plus=-0.5*sin_tf+0.5*sq_three*cos_tf;
		cos_tf_plus=-0.5*cos_tf-0.5*sq_three*sin_tf;
		sin_tf_sub=-0.5*sin_tf-0.5*sq_three*cos_tf;
		cos_tf_sub=-0.5*cos_tf+0.5*sq_three*sin_tf;
		cur_dq_v.fir=cur_abc_v.fir*cos_tf+cur_abc_v.sec*cos_tf_sub+cur_abc_v.thi*cos_tf_plus;
		cur_dq_v.sec=-cur_abc_v.fir*sin_tf-cur_abc_v.sec*sin_tf_sub-cur_abc_v.thi*sin_tf_plus;
		cur_dq_v.sta=true;
		return cur_dq_v;
	}
	else
	{
		cur_dq_v.sta=false;
		return cur_dq_v;
	}
}

/*
	*transfer voltage vector from dq coordinate system to alpha-beta coordinate system
	*volt_dq_v=(vd,vq,default,status)   theta_tf is the angle at which the d-axis is ahead of the a-axis  !rad
	*return para=(v_alpha,v_beta,default,status)
	*After transformation, the vector modulus does not change
*/
struct tri_vector Inv_Park_Tf(struct tri_vector volt_dq_v,float theta_tf)
{
	struct tri_vector volt_albe_v;
	if(volt_dq_v.sta)
	{
		float sin_tf,cos_tf;
		sin_tf=arm_sin_f32(theta_tf);
		cos_tf=arm_cos_f32(theta_tf);
		volt_albe_v.fir=volt_dq_v.fir*cos_tf-volt_dq_v.sec*sin_tf;
		volt_albe_v.sec=volt_dq_v.fir*sin_tf+volt_dq_v.sec*cos_tf;
		volt_albe_v.sta=true;
		return volt_albe_v;
	}
	else
	{
		volt_albe_v.sta=false;
		return volt_albe_v;
	}
}

/*
	current loop
	before using this function,shoule initialize id_ref,iq_ref,kp_d,ki_d,kp_q,ki_q;
*/
void current_loop()
{
	//cal theta_e
	theta_e=(((float)encPositionA)-angle_offset)*pulse_to_rad*pole_pair;
	
//	theta_e=0;
	
//			theta_e+=0.005;
	
	while(theta_e<0)
		theta_e+=2*pi;
	while(theta_e>2*pi)
		theta_e-=2*pi;
//	

	
	struct tri_vector Iabc,Idq,Udq,Ualbe,Uabc;
	Iabc.fir=ia,Iabc.sec=ib,Iabc.thi=ic,Iabc.sta=true;
	Idq=Clark_Park_Tf(Iabc,theta_e);
	id=Idq.fir;
	iq=Idq.sec;
	
	//id iq filter
	id=0.8*id+0.2*(id_pre);
	iq=0.8*iq+0.2*(iq_pre);
	id_pre=id;
	iq_pre=iq;
	
	float del_id=id_ref-id;
	integ_d+=del_id;
	ud=kp_d*del_id+ki_d*integ_d*cycle;
	
	float del_iq=iq_ref-iq;
	integ_q+=del_iq*cycle;
	uq=kp_q*del_iq+ki_q*integ_q;
	
	//voltage Standardization
	float mod_to_V=dc_bus;
	float V_to_mod=1/dc_bus;
	ud_mod=ud*V_to_mod;
	uq_mod=uq*V_to_mod;
	
	//voltage limitation  0.8*sqrt(3)/2
	float volt_vec_mod,sqrt_volt_vec_mod;
	volt_vec_mod=ud_mod*ud_mod+uq_mod*uq_mod;
	arm_sqrt_f32(volt_vec_mod,&sqrt_volt_vec_mod);
	scalefactor=one_div_sq_three*1.5*0.8/sqrt_volt_vec_mod;
	if(scalefactor<1)
	{
		ud_mod*=scalefactor;
		uq_mod*=scalefactor;
	}
	
	Udq.fir=ud_mod;
	Udq.sec=uq_mod;
	Udq.sta=true;
	Ualbe=Inv_Park_Tf(Udq,theta_e);
	Uabc=SVPWM(Ualbe.fir,Ualbe.sec);
	apply_pwm(Uabc);
}

void speed_loop()
{
	float del_vel_m=vel_ref-vel_fil;
	integ_vel+=del_vel_m*cycle*16;
	iq_ref=(kp_vel*del_vel_m+ki_vel*integ_vel)*J_iner*one_div_k_tor;
//	iq_ref+=iq_anticog[encPositionA];
	if(iq_ref>i_vec_mod_lim*0.6)
		iq_ref=i_vec_mod_lim*0.6;
	if(iq_ref<-i_vec_mod_lim*0.6)
		iq_ref=-i_vec_mod_lim*0.6;
	
	id_ref=0;
}

void pos_loop()
{
	float del_pos=pos_ref-vel_m*cycle*16;//unit rad/T
	integ_pos+=kp_pos*del_pos*cycle*16;	//unit rad/T
	vel_ref=integ_pos*one_div_cycle/16;								//unit rad/s
	if(vel_ref>vel_ref_lim)
		vel_ref=vel_ref_lim;
	if(vel_ref<-vel_ref_lim)
		vel_ref=-vel_ref_lim;
}

